__author__ = 'kaiolae'

import argparse
import pickle
from os.path import dirname, join
from plan_optimization.planEvaluatorSetup import preparePlanEvaluator
import settings.Constants_and_Datastructures
import settings.Utilities as Utilities
from osg_cpp_binding.eval_func import normal, circulating

def plotIndividual(base_folder, indivNr, fileName = "winner_indivs.pkl", circulating_plot = False):
    populationFile = join(join(base_folder,settings.Constants_and_Datastructures.populationsSubFolder),fileName)
    loadedData = pickle.load(open(populationFile, "rb"))
    population = loadedData[settings.Constants_and_Datastructures.populationName]
    mandLoopsFolder = ""
    if params.PLAN_ENCODING is settings.Constants_and_Datastructures.PlanEncoding.dualGenotype or params.PLAN_ENCODING is settings.Constants_and_Datastructures.PlanEncoding.interleavedGenotype:
        mandLoopsFolder = join(base_folder,settings.Constants_and_Datastructures.mandSegmentsSubFolder)
    plot_func = preparePlanEvaluator(loadedData, mandLoopsFolder, settings.Constants_and_Datastructures.MANDATORY_PARTS_FILE_ENDING)

    plottedIndiv = population[indivNr]
    print "Plotted individual is ", plottedIndiv
    print "Fitness is ", plottedIndiv.fitness.values

    #TODO: Remove this testing-code.
    #Original genotype: [[184.0], [239.0], [247.0], [283.0], [285.0], [241.0], [235.0], [199.0], [192.0], [129.0], [127.0], [178.0], [184.0], [759.0], [755.0], [570.0], [761.0], [750.0], [748.0], [757.0], [587.0], [760.0], [756.0], [751.0], [758.0], [590.0], [753.0], [752.0], [573.0], [754.0], [749.0], [570.0]]

    #plottedIndiv[:] = [[239.0], [247.0], [283.0], [285.0], [241.0], [235.0], [199.0], [192.0], [129.0], [127.0], [178.0], [184.0], [759.0], [755.0], [570.0], [761.0], [750.0], [748.0], [757.0], [587.0], [760.0], [756.0], [751.0], [758.0], [590.0], [753.0], [752.0], [573.0], [754.0], [749.0], [570.0]]
    if circulating_plot:
        # TODO: parameters for circulating plans are not possible to set here yet. Enable passing these from python.
        plot_type = circulating
    else:
        plot_type = normal

    print "Plot type is ", plot_type

    if params.PLAN_ENCODING == settings.Constants_and_Datastructures.PlanEncoding.dualGenotype:
        (obj1,obj2) = plot_func.evaluatePlan(plottedIndiv.combinedGenotype,False, plot_type)
    else:
        (obj1,obj2) = plot_func.evaluatePlan(plottedIndiv,False, plot_type)

    #(obj1,obj2) = plot_func.evaluatePlan(plottedIndiv,False, True)
    print "Scores: ", obj1, ", ", obj2

    #(obj1,obj2) = plot_func.evaluatePlan(plottedIndiv,True)

def printFitnesses(loadFile):
    loadedData = pickle.load(open(loadFile, "rb"))
    population = loadedData[settings.Constants_and_Datastructures.populationName]
    for p in population:
        print p.fitness.values

def parse_input_arguments():
    # Parsing user inputs:
    parser = argparse.ArgumentParser(
        description='Allows the user to visualize a plan in 3D, in order to study it thoroughly.')

    # Mandatory Arguments
    mandatory_arguments = parser.add_argument_group("Mandatory Arguments")
    mandatory_arguments.add_argument('-i','--input_folder', type=str, required=True,
                                     help='Path to folder containing your plans (this should be your results-folder,'
                                          ' which contains the sub-folder "populations").')

    #Optional arguments
    parser.add_argument('--id', type = int, required=True, help='The ID number of the plan you would like to plot. This number can be found at the beginning of'
                                     " the filename of the image of the plan. It is a good idea to generate plan images first, and then"
                                     " study plans in more detail with this visualizer when necessarry. The ID is an integer, between 0 "
                                     "and the number of solutions generated by the optimizer.")

    parser.add_argument('--circulating', action='store_true',
                        help='If given, the plan is shown by the camera automatically circling around the structure,'
                             'instead of the user controlling the camera.')

    args = parser.parse_args()
    return args

if __name__ == "__main__":

    args = parse_input_arguments()
    base_folder = args.input_folder
    indivNr = args.id
    paramsFile = join(base_folder,join(settings.Constants_and_Datastructures.parametersSubFolder,"Parameters.py"))
    params = Utilities.importFromURI(paramsFile)

    loadFile = "base_plans.pkl"
    print "Circulating was ", args.circulating
    plotIndividual(base_folder, indivNr, loadFile, args.circulating)
    #printFitnesses(loadFile)
